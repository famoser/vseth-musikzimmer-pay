agnes:
  version: 4

build:
  path: .build

github:
  api_token: '%env(GITHUB_API_TOKEN)%'
  repository: famoser/vseth-musikzimmer-pay

config:
  path: .config
  repository:
    url: git@gitlab.com:agnes-config/famoser-vseth-musikzimmer-pay

data:
  shared_folders:
    - var

  files:
    - path: .env.local
      required: true

scripts:
  build:
    hook: build
    script:
      - composer install --verbose --prefer-dist --no-interaction --no-dev --optimize-autoloader --no-scripts
      - yarn install
      - yarn run encore production
      - rm -rf node_modules

  release:
    after: release
    script:
      # TODO: check if executed as expected
      # backup source to VSETH deploy repository
      - git clone git@gitlab.ethz.ch:vseth/0300-vs/musikzimmer-pay.git deploy
      - mkdir -p ./deploy/source
      - git bundle create ./deploy/source/source.git-bundle --all
      - git --git-dir=./deploy/.git --work-tree=./deploy add ./source/source.git-bundle
      - git --git-dir=./deploy/.git commit -m "update source bundle"
      - git --git-dir=./deploy/.git push
      - rm -rf deploy

  deploy:
    hook: deploy
    script:
      - php bin/console cache:clear -n
      - find var -type d -print0 | xargs -0 chmod 0755
      - find var -type f -print0 | xargs -0 chmod 0644
      - php bin/console doctrine:migrations:migrate -n

  rollback:
    hook: rollback
    script:
      - cd $PREVIOUS_RELEASE_PATH && export MIGRATE_TO=$(php bin/console doctrine:migrations:latest)
      - php bin/console doctrine:migrations:migrate $MIGRATE_TO -n
